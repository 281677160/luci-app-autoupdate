<%+cbi/valueheader%>
<div class="cbi-value-field">
    <input class="cbi-button cbi-button-apply" type="button" value="<%:检查更新%>" 
        onclick="startUpdateProcess()" id="upgrade-btn" />
    <span id="status-message" class="status-message"></span>
</div>
<script type="text/javascript">
(function() {
    const elements = {
        btn: document.getElementById('upgrade-btn'),
        status: document.getElementById('status-message')
    };
    let statusInterval = null;

    const updateUI = (state) => {
        elements.btn.disabled = state.disabled;
        if (state.text) elements.btn.value = state.text;
        if (state.status) {
            elements.status.textContent = state.status;
            elements.status.style.color = state.error ? '#d44' : '#4a4';
        }
    };

    const checkStatus = async (retries = 0) => {
        try {
            const res = await fetch('<%=url("admin/system/autoupdate/check_status")%>');
            const data = await res.json();
            
            if (data.running) {
                updateUI({ status: data.message || '升级进行中' });
            } else {
                clearInterval(statusInterval);
                updateUI({
                    disabled: false,
                    text: '<%:检查更新%>',
                    status: data.message || (data.success ? '升级成功' : '升级失败'),
                    error: !data.success
                });
            }
        } catch (e) {
            if (retries < 3) {
                setTimeout(() => checkStatus(retries + 1), 1000);
            } else {
                clearInterval(statusInterval);
                updateUI({
                    disabled: false,
                    text: '<%:检查更新%>',
                    status: '状态检查失败',
                    error: true
                });
            }
        }
    };

    const startUpgrade = async () => {
        try {
            const res = await fetch('<%=url("admin/system/autoupdate/do_upgrade")%>', { 
                method: 'POST' 
            });
            const data = await res.json();
            
            if (!data.success) throw new Error(data.message);
            
            updateUI({
                disabled: true,
                text: '升级中...',
                status: '后台升级已启动'
            });
            statusInterval = setInterval(checkStatus, 3000);
        } catch (e) {
            updateUI({
                disabled: false,
                text: '<%:检查更新%>',
                status: e.message || '启动升级失败',
                error: true
            });
        }
    };

    window.startUpdateProcess = async () => {
        if (elements.btn.disabled) return;
        
        updateUI({
            disabled: true,
            text: '检查中...',
            status: '正在检查更新...'
        });

        try {
            const res = await fetch('<%=url("admin/system/autoupdate/do_check")%>', { 
                method: 'POST' 
            });
            const data = await res.json();
            
            if (!data.success) throw new Error(data.message);
            if (data.has_update && confirm(data.message)) {
                await startUpgrade();
            } else {
                updateUI({
                    disabled: false,
                    text: '<%:检查更新%>',
                    status: data.message
                });
            }
        } catch (e) {
            updateUI({
                disabled: false,
                text: '<%:检查更新%>',
                status: e.message || '检测失败,请查看日志',
                error: true
            });
        }
    };
})();
</script>
<%+cbi/valuefooter%>
