#!/bin/sh

#====================================================
#	Author:	281677160
#	Dscription: openwrt onekey Management
#	github: https://github.com/281677160/build-actions
#====================================================

# 字体颜色配置
Green="\033[32m"
Red="\033[31m"
Yellow="\033[33m"
Blue="\033[36m"
Font="\033[0m"
GreenBG="\033[1;36m"
RedBG="\033[41;37m"
OK="${Green}[OK]${Font}"
ERROR="${Red}[ERROR]${Font}"
Input_Option=$1

function ECHOY() {
  echo
  echo -e "${Yellow} $1 ${Font}"
  echo
}
function ECHOR() {
  echo -e "${Red} $1 ${Font}"
  echo
}
function ECHORR() {
  echo
  echo -e "${Red} $1 ${Font}"
}
function ECHOB() {
  echo
  echo -e "${Blue} $1 ${Font}"
}
function ECHOBG() {
  echo
  echo -e "${GreenBG} $1 ${Font}"
}
function ECHOYY() {
  echo -e "${Yellow} $1 ${Font}"
}
function ECHOG() {
  echo
  echo -e "${Green} $1 ${Font}"
}
function print_ok() {
  echo
  echo -e " ${OK} ${Blue} $1 ${Font}"
  echo
}
function print_error() {
  echo
  echo -e "${ERROR} ${RedBG} $1 ${Font}"
  echo
}
function print_gg() {
  echo
  echo -e "${GX}${Green} $1 ${Font}"
  echo
}

function information_acquisition() {
clear
echo
ECHOY " 开始执行资料读取,读取完毕显示选择固件界面"

source /etc/openwrt_replace

A="$(wget -V |grep 'GNU Wget' |grep -Eo "[0-9]+\.[0-9]+\.[0-9]+")"
B="1.16.1"
if [[ `awk -v num1=${A} -v num2=${B} 'BEGIN{print(num1>num2)?"0":"1"}'` -eq '0' ]]; then
  WGETGNU="wget -q --show-progress"
  WGETO="-O"
else
  WGETGNU="curl -# -L"
  WGETO="-o"
fi

Kernel=$(grep 'Version' /usr/lib/opkg/info/kernel.control |grep -Eo "[0-9]+\.[0-9]+\.[0-9]+")
[ ! -d "${Download_Path}" ] && mkdir -p ${Download_Path} || rm -rf "${Download_Path}"/*
GUJIAN_liebiaoone="${Download_Path}/gujianliebiaoone"
GUJIAN_liebiaotwo="${Download_Path}/gujianliebiaotwo"
GUJIAN_liebiaotw="${Download_Path}/gujianliebiaotw"

ECHOG "[$(date "+%Y年%m月%d日%H时%M分%S秒") 检测您网络是否联网]"
sleep 2
wget -qT 10 --no-check-certificate ${Github_API1} -O ${API_PATH}
if [[ -f "${API_PATH}" ]] && [[ `grep -c "size" ${API_PATH}` -ge '1' ]]; then
  CHN_NET="1"
else
  CHN_NET="0"
fi

if [[ "${CHN_NET}" == "0" ]]; then
  curl --connect-timeout 10 "baidu.com" > "/dev/null" 2>&1 || wangluo='1'
fi
if [[ "${wangluo}" == "1" ]]; then
  curl --connect-timeout 10 "google.com" > "/dev/null" 2>&1 || wangluo='2'
fi
if [[ "${wangluo}" == "1" ]] && [[ "${wangluo}" == "2" ]]; then
  ECHOR "[$(date "+%Y年%m月%d日%H时%M分%S秒") 您可能没进行联网,请检查网络?"
  exit 1
else
  ECHOB "[$(date "+%Y年%m月%d日%H时%M分%S秒") 网络联网正常]"
  sleep 2
fi

ECHOG "[$(date "+%Y年%m月%d日%H时%M分%S秒") 检测网络类型]"
if [[ "${CHN_NET}" == "1" ]]; then
  ECHOB "[$(date "+%Y年%m月%d日%H时%M分%S秒") 您的网络可以直连Github!]"
  sleep 2
  ECHOG "[$(date "+%Y年%m月%d日%H时%M分%S秒") 获取云端API]"
  sleep 2
else
  rm -rf ${API_PATH}
  ECHOB "[$(date "+%Y年%m月%d日%H时%M分%S秒") 您的网络需要使用代理下载固件,网速或许有影响]"
  sleep 2
  ECHOG "[$(date "+%Y年%m月%d日%H时%M分%S秒") 获取云端API]"
  sleep 2
  echo
  ${WGETGNU} ${Github_API2} ${WGETO} ${API_PATH}
fi

if [[ -f "${API_PATH}" ]] && [[ `grep -c "url" ${API_PATH}` -ge '1' ]]; then
  ECHOB "[$(date "+%Y年%m月%d日%H时%M分%S秒") 获取云端API完成,开始获取固件信息]"
  sleep 2
else
  ECHOR "[$(date "+%Y年%m月%d日%H时%M分%S秒") 获取数据失败,Github地址不正确,或此地址没云端存在,或您的仓库为私库,或网络抽风了再试试看!]"
  exit 1
fi

case "${TARGET_BOARD}" in
x86)
  [ -d '/sys/firmware/efi' ] && {
    BOOT_Type=uefi
  } || {
    BOOT_Type=legacy
  }
;;
*)
  BOOT_Type=sysupgrade
esac


CLOUD_Firmware_1="$(grep -Eo "${ledezx}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_2="$(grep -Eo "${lienolzx1}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_3="$(grep -Eo "${lienolzx2}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_4="$(grep -Eo "${lienolzx3}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_5="$(grep -Eo "${lienolzx4}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_6="$(grep -Eo "${immortalwrtzx1}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_7="$(grep -Eo "${immortalwrtzx2}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_8="$(grep -Eo "${immortalwrtzx3}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_9="$(grep -Eo "${immortalwrtzx4}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_10="$(grep -Eo "${officialzx1}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_11="$(grep -Eo "${officialzx2}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_12="$(grep -Eo "${officialzx3}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_13="$(grep -Eo "${officialzx4}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_14="$(grep -Eo "${xwrtzx1}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_15="$(grep -Eo "${xwrtzx2}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_16="$(grep -Eo "${xwrtzx3}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_17="$(grep -Eo "${xwrtzx4}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_18="$(grep -Eo "${xwrtzx5}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_19="$(grep -Eo "${xwrtzx6}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_20="$(grep -Eo "${xwrtzx7}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_21="$(grep -Eo "${xwrtzx8}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_22="$(grep -Eo "${xwrtzx9}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_23="$(grep -Eo "${xwrtzx10}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_24="$(grep -Eo "${xwrtzx11}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_25="$(grep -Eo "${xwrtzx12}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_26="$(grep -Eo "${xwrtzx13}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_27="$(grep -Eo "${xwrtzx14}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_28="$(grep -Eo "${xwrtzx15}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_29="$(grep -Eo "${xwrtzx16}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_30="$(grep -Eo "${xwrtzx17}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_31="$(grep -Eo "${xwrtzx18}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_32="$(grep -Eo "${xwrtzx19}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_33="$(grep -Eo "${xwrtzx20}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_34="$(grep -Eo "${xwrtzx21}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_35="$(grep -Eo "${xwrtzx22}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_36="$(grep -Eo "${xwrtzx23}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_37="$(grep -Eo "${xwrtzx24}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_38="$(grep -Eo "${xwrtzx25}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_39="$(grep -Eo "${xwrtzx26}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_40="$(grep -Eo "${xwrtzx27}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_41="$(grep -Eo "${xwrtzx28}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"
CLOUD_Firmware_42="$(grep -Eo "${xwrtzx29}-${DEFAULT_Device}-[0-9]+-${BOOT_Type}-[a-zA-Z0-9]+${Firmware_SFX}" ${API_PATH} | awk 'END {print}')"

cat > "${GUJIAN_liebiaoone}" <<-EOF
${CLOUD_Firmware_1}
${CLOUD_Firmware_2}
${CLOUD_Firmware_3}
${CLOUD_Firmware_4}
${CLOUD_Firmware_5}
${CLOUD_Firmware_6}
${CLOUD_Firmware_7}
${CLOUD_Firmware_8}
${CLOUD_Firmware_9}
${CLOUD_Firmware_10}
${CLOUD_Firmware_11}
${CLOUD_Firmware_12}
${CLOUD_Firmware_13}
${CLOUD_Firmware_14}
${CLOUD_Firmware_15}
${CLOUD_Firmware_16}
${CLOUD_Firmware_17}
${CLOUD_Firmware_18}
${CLOUD_Firmware_19}
${CLOUD_Firmware_20}
${CLOUD_Firmware_21}
${CLOUD_Firmware_22}
${CLOUD_Firmware_23}
${CLOUD_Firmware_24}
${CLOUD_Firmware_25}
${CLOUD_Firmware_26}
${CLOUD_Firmware_27}
${CLOUD_Firmware_28}
${CLOUD_Firmware_29}
${CLOUD_Firmware_30}
${CLOUD_Firmware_31}
${CLOUD_Firmware_32}
${CLOUD_Firmware_33}
${CLOUD_Firmware_34}
${CLOUD_Firmware_35}
${CLOUD_Firmware_36}
${CLOUD_Firmware_37}
${CLOUD_Firmware_38}
${CLOUD_Firmware_39}
${CLOUD_Firmware_40}
${CLOUD_Firmware_41}
${CLOUD_Firmware_42}
EOF
sed -i '/^$/d' "${GUJIAN_liebiaoone}"
sed -i s/[[:space:]]//g "${GUJIAN_liebiaoone}"
if [[ -s "${GUJIAN_liebiaoone}" ]]; then
  local_firmw="${LUCI_EDITION}-${SOURCE}"
  LOCAL_Version=$(echo "${CURRENT_Version}"|grep -Eo [0-9]+[0-9]+[0-9]+[0-9]+[0-9]+[0-9]+[0-9]+[0-9]+[0-9]+[0-9]+[0-9]+[0-9]+)
  kk=$(grep "${local_firmw}" "${GUJIAN_liebiaoone}")
  CLOUD_Version=$(echo "${kk}"|grep -Eo [0-9]+[0-9]+[0-9]+[0-9]+[0-9]+[0-9]+[0-9]+[0-9]+[0-9]+[0-9]+[0-9]+[0-9]+)
  cat "${GUJIAN_liebiaoone}" |awk '$0=NR" "$0' > "${GUJIAN_liebiaotw}"
  XYZDSZ="$(cat "${GUJIAN_liebiaotw}" | awk 'END {print}' |awk '{print $(1)}')"
  if [[ -n "${kk}" ]] && [[ "${XYZDSZ}" -eq "1" ]]; then
    yunduan_shuju="1"
  elif [[ -z "${kk}" ]] && [[ "${XYZDSZ}" -ge "1" ]]; then
    yunduan_shuju="2"
  elif [[ -n "${kk}" ]] && [[ "${XYZDSZ}" -gt "1" ]]; then
    yunduan_shuju="3"
    sed -i "/${kk}/d" "${GUJIAN_liebiaoone}"
    sed -i "1i${kk}" "${GUJIAN_liebiaoone}"
  fi
else
  echo "没有获取到任何数据"
  yunduan_shuju="0"
fi
cat "${GUJIAN_liebiaoone}" |awk '$0=NR" "$0' > ${GUJIAN_liebiaotwo}
}

function firmware_upgrade() {
bb="$(echo ${CLOUD_Firmware} |grep -o "\-${DEFAULT_Device}.*")"
cloud_firmw=$(echo "${CLOUD_Firmware}" |sed "s/${bb}//g")

if [[ "${local_firmw}" == "${cloud_firmw}" ]]; then
  echo
  ECHOYY "此固件跟您现在所用的固件为同一个源码作者同一个LUCI版本,"
  echo
  ECHOYY "可以选择保留配置或不保留配置升级"
  echo
  xuzqxz="输入[Y/y]为保留配置，输入[N/n]为不保留配置"
  while :; do
  read -p " ${xuzqxz}： " Bendi_Wsl
  case ${Bendi_Wsl} in
  [Yy])
    Upgrade_Options='sysupgrade -F -f /mnt/upback.tar.gz'
    upgrade_tions="1"
    tongzhi="保留配置"
  break
  ;;
  [Nn])
    Upgrade_Options='sysupgrade -F -n'
    tongzhi="不保留配置"
  break
  ;;
  *)
    xuzqxz="请输入正确选[Y/n]"
  ;;
  esac
  done
else
   Upgrade_Options='sysupgrade -F -n'
   tongzhi="不保留配置"
fi


cd "${Download_Path}"
ECHOG "[$(date "+%Y年%m月%d日%H时%M分%S秒") 检查路由器剩余空间"
TMP_Available=$(df -m | grep "/tmp" | awk '{print $4}' | awk 'NR==1' | awk -F. '{print $1}')
let X=$(grep -n "${CLOUD_Firmware}" ${API_PATH} | tail -1 | cut -d : -f 1)-4
let CLOUD_Firmware_Size=$(sed -n "${X}p" ${API_PATH} | grep -Eo "[0-9]+" | awk '{print ($1)/1048576}' | awk -F. '{print $1}')+1
if [[ "${TMP_Available}" -lt "${CLOUD_Firmware_Size}" ]]; then
  ECHOR "[$(date "+%Y年%m月%d日%H时%M分%S秒") 路由器tmp空间值[${TMP_Available}M],云端固件体积[${CLOUD_Firmware_Size}M],空间不足，不能下载]"
  exit 1
else
  ECHOB "[$(date "+%Y年%m月%d日%H时%M分%S秒") 路由器tmp空间值[${TMP_Available}M],云端固件体积[${CLOUD_Firmware_Size}M],空间充足]"
  sleep 2
fi

if [[  "$(curl -I -s --connect-timeout 8 google.com -w %{http_code} | tail -n1)" == "301" ]]; then
  DOWNLOAD=${Release_download}
else
  DOWNLOAD=https://ghproxy.com/${Release_download}
fi
ECHOG "[$(date "+%Y年%m月%d日%H时%M分%S秒") 正在下载云端固件,请耐心等待..]"
echo
${WGETGNU} ${DOWNLOAD}/${CLOUD_Firmware} ${WGETO} ${CLOUD_Firmware}
if [[ $? -ne 0 ]];then
  wget --no-check-certificate ${DOWNLOAD}/${CLOUD_Firmware} -O ${CLOUD_Firmware}
fi
if [[ $? -ne 0 ]];then
  ECHOR "[$(date "+%Y年%m月%d日%H时%M分%S秒") 下载云端固件失败,请检查网络再尝试或手动安装固件]"
  exit 1
else
  ECHOB "[$(date "+%Y年%m月%d日%H时%M分%S秒") 下载云端固件成功!]"
  sleep 2
fi

ECHOG "[$(date "+%Y年%m月%d日%H时%M分%S秒") 对比固件MD5和SHA256SUM值,预防固件下载过程中有损坏]"
LOCAL_MD5256=$(md5sum ${CLOUD_Firmware} |cut -c1-3)$(sha256sum ${CLOUD_Firmware} |cut -c1-3)
CLOUD__MD5256=$(echo ${CLOUD_Firmware} | grep -Eo "[a-zA-Z0-9]+${Firmware_SFX}" | sed -r "s/(.*)${Firmware_SFX}/\1/")
if [[ "${CLOUD__MD5256}" == "${LOCAL_MD5256}" ]]; then
  ECHOB "[$(date "+%Y年%m月%d日%H时%M分%S秒") MD5对比成功!]"
  sleep 2
else
  ECHOR "[$(date "+%Y年%m月%d日%H时%M分%S秒") MD5对比失败,固件可能在下载时损坏,请检查网络后重试!]"
  exit 1
fi

cd "${Download_Path}"
ECHOG "[倒计10秒后,执行[${tongzhi}]更新,更新期间请不要断开电源或重启设备 ...]"
sleep 1
seconds=9
while [ $seconds -gt 0 ];do
  echo -n $seconds
  sleep 1
  seconds=$(($seconds - 1))
  echo -ne "\r	\r"
done
chmod 777 "${CLOUD_Firmware}"
if [[ `opkg list | awk '{print $1}' | grep -c gzip` -ge '1' ]]; then
  opkg remove gzip > /dev/null 2>&1
fi
sleep 2
if [[ "${upgrade_tions}" == "1" ]]; then
  if [[ -f "/etc/deletefile" ]]; then
    chmod +x "/etc/deletefile"
    source /etc/deletefile
  fi
  rm -rf /etc/config/luci
  echo "*/5 * * * * sh /etc/networkdetection > /dev/null 2>&1" >> /etc/crontabs/root
  rm -rf /mnt/*upback.tar.gz && sysupgrade -b /mnt/upback.tar.gz
  if [[ `ls -1 /mnt | grep -c "upback.tar.gz"` -eq '1' ]]; then
    ${Upgrade_Options} ${CLOUD_Firmware}
  else
    ${Upgrade_Options} ${CLOUD_Firmware}
  fi
else
  ${Upgrade_Options} ${CLOUD_Firmware}
fi
}

function Bendi_githuburl() {
Github="$(grep 'GITHUB_LINK=' "/etc/openwrt_replace" | cut -d "=" -f2)"
ECHOY "提示：您现在检测云端的地址为：

 ${Github}

 是否更换地址检测?
 
 此地址不局限于自己的仓库,同样用同一个上游编译脚本的,对方有编译同样架构的固件,
 
 您改成对方的github地址也可以搜索到固件"
read -p " 输入[Y/y]为选择需要,任意键回车则为不需要：" dogithub
case $dogithub in
[Yy])
  export Input_Oth="Y"
;;
*)
  export Input_Oth="n"
;;
esac
}

function Bendi_githuy() {
if [[ "${Input_Oth}" == "Y" ]]; then
  ECHOG "正确地址格式：https://github.com/帐号/仓库"
  export YUMING=" 请输入新的地址"      
  while :; do
  read -p "${YUMING}：" cus_url
  if [[ "${cus_url}" == "${Github}" ]]; then
    dogithu="x"
  elif [[ -z "${cus_url}" ]]; then
    dogithu="z"
  elif [[ "$(echo "${cus_url}" |head -n 5 |cut -d '/' -f 1-3)" == 'https://github.com' ]]; then
    custom_github_url="$(echo "${cus_url}" |head -n 5 |cut -d '/' -f 4-5)"
    current_github_url="$(grep GITHUB_LINK= /etc/openwrt_replace |head -n 5 |cut -d '/' -f 4-5)"
    if [[ -n "${custom_github_url}" ]] && [[ `echo "${custom_github_url}" |grep -c '/'` -eq '1' ]]; then
      sed -i "s?${current_github_url}?${custom_github_url}?g" /etc/openwrt_replace
      dogithu="t"
    else
      dogithu="n"
    fi
  else
    dogithu="w"
  fi
  case $dogithu in
  x)
    ECHOY "您输入的新地址跟当前地址一致,无需修改,即将进入云端检测程序"
    sleep 5
  break
  ;;
  z)
    ECHOR "地址不能为空"
    Bendi_githuy
  break
  ;;
  n)
    ECHOR "不能获取地址,地址格式或者不正确"
    Bendi_githuy
  break
  ;;
  t)
    ECHOG "地址修改成功,即将进入云端检测程序"
    Github="$(grep 'GITHUB_LINK=' "/etc/openwrt_replace" | cut -d "=" -f2)"
    ECHOYY "您当前地址：${Github}"
    sleep 8
  break
  ;;
  w)
    export YUMING="敬告：您输入的Github地址无效,请输入正确格式的Github地址!"
  break
  esac
  done
fi
}


function Bendi_xuanzhe() {
  clear
  echo
  echo " Openwrt-AutoUpdate Script ${Version}"
  echo
  echo
  echo -e "${Green} 当前使用固件${Font}：${Blue}${CURRENT_Version}${Font}"
  echo -e "${Green} 当前固件内核${Font}：${Blue}${Kernel}${Font}"
  echo -e "${Green} 当前固件格式${Font}：${Blue}${BOOT_Type}${Firmware_SFX}${Font}"
  echo -e "${Green} 当前设备型号${Font}：${Blue}${DEFAULT_Device}${Font}"
  echo
  echo
  case "${yunduan_shuju}" in
  0)
    ECHOR " 没有获取到任何数据"
  ;;
  1)
    ECHOYY " 以下为可选升级固件："
    ECHOG " ******************************************************************" 
    echo
    cat "${GUJIAN_liebiaoone}" |awk '$0=NR"、"$0'|awk '{print "  " $0}'
    ECHOG " ******************************************************************" 
    ECHORR " 没发现云端有其他作者源码的固件存在,需要转换其他作者源码固件请先编译"
    ECHOG " 云端固件跟您现在所用的为同类型固件，可进行选择保留配置或者不保留配置升级"
    echo
    if [[ "${LOCAL_Version}" -eq "${CLOUD_Version}" ]]; then
      echo "  提示：当前版本跟云端同类型固件版本是一致的"
    elif [[ "${LOCAL_Version}" -lt "${CLOUD_Version}" ]]; then
      echo "  提示：云端同类型固件有更高版本固件,可进行更新操作"
    elif [[ "${LOCAL_Version}" -gt "${CLOUD_Version}" ]]; then
      echo "  提示：不得了啊,兄弟,云端最高版本固件,低于您现在所安装的版本"
    fi
    ECHOB " 请输入您要升级的固件名称前面对应的数值(1~X),输入[0或N]则为退出程序"
  ;;
  2)
    ECHOYY " 以下为可选升级固件："
    ECHOG " ******************************************************************" 
    echo
    cat "${GUJIAN_liebiaoone}" |awk '$0=NR"、"$0'|awk '{print "  " $0}'
    ECHOG " ******************************************************************" 
    ECHORR " 云端没发现有您现在所用的同类型固件，您可以进行转换其他源码作者固件操作"
    ECHOG " 转换其他源码作者固件，都不保留配置升级"
    ECHOB " 请输入您要转换的固件名称前面对应的数值(1~X),输入[0或N]则为退出程序"
  ;;
  3)
    ECHOYY " 以下为可选升级固件："
    ECHOG " ******************************************************************" 
    echo
    cat "${GUJIAN_liebiaoone}" |awk '$0=NR"、"$0'|awk '{print "  " $0}'
    ECHOG " ******************************************************************" 
    ECHORR " 第一选择为您现在所用固件的同类型，可进行选择保留配置或者不保留配置升级"
    echo
    if [[ "${LOCAL_Version}" -eq "${CLOUD_Version}" ]]; then
      echo "  提示：当前版本跟云端同类型固件版本是一致的"
    elif [[ "${LOCAL_Version}" -lt "${CLOUD_Version}" ]]; then
      echo "  提示：云端同类型固件有更高版本固件,可进行更新操作"
    elif [[ "${LOCAL_Version}" -gt "${CLOUD_Version}" ]]; then
      echo "  提示：不得了啊,兄弟,云端最高版本固件,低于您现在所安装的版本"
    fi
    ECHOG " 其他的固件因为作者或者LUCI不同型号，都不保留配置升级"
    ECHOB " 请输入您要升级或者转换的固件名称前面对应的数值(1~X),输入[0或N]则为退出程序"
  ;;
  esac
  if [[ ! "${yunduan_shuju}" == "0" ]]; then
    echo
    export YUMINGIP="  请输入数字(1~N)"
    while :; do
    YMXZ=""
    read -p "${YUMINGIP}：" YMXZ
    if [[ "${YMXZ}" == "0" ]] || [[ "${YMXZ}" == "N" ]] || [[ "${YMXZ}" == "n" ]]; then
      CUrrenty="N"
    elif [[ -z "${YMXZ}" ]]; then
      CUrrenty="x"
    elif [[ "${YMXZ}" -le "${XYZDSZ}" ]]; then
      CUrrenty="Y"
      YMXZ=${YMXZ}
    else
      CUrrenty="x"
    fi
    case $CUrrenty in
    Y)
      CLOUD_Firmware=$(cat ${GUJIAN_liebiaoone} |awk ''NR==${YMXZ}'')
      ECHOY " 您选择了[${CLOUD_Firmware}]固件"
      sleep 2
      firmware_upgrade
    break
    ;;
    N)
      echo
      exit 0
    break
    ;;
    *)
      export YUMINGIP="  敬告,请输入正确数值"
    ;;
    esac
    done
  fi
}

function menu() {
  clear
  echo
  echo
  echo -e " 1${Red}.${Font}${Green}获取云端固件信息${Font}"
  echo
  echo -e " 2${Red}.${Font}${Green}退出${Font}"
  echo
  echo
  XUANZop="请输入数字"
  echo
  while :; do
  read -p " ${XUANZop}：" menu_num
  case $menu_num in
  1)
    Bendi_githuburl
    Bendi_githuy
    information_acquisition
    Bendi_xuanzhe
  break
  ;;
  2)
    echo
    exit 0
  break
  ;;
  *)
    XUANZop="请输入正确的数字编号"
  ;;
  esac
  done
}

if [[ -z "${Input_Option}" ]]; then
  menu
else
  case ${Input_Option} in
  -u)
    Bendi_githuburl
    Bendi_githuy
    information_acquisition
    Bendi_xuanzhe
  ;;
  esac
fi
